//! Action result type.
//!
//! The [`ActionResult`] enum is the return type for all action handlers,
//! describing what the editor should do after an action executes.

use std::sync::{Mutex, OnceLock};

use xeno_macro::DispatchResult;

use crate::editor_ctx::ResultHandler;
use crate::effects::ActionEffects;

/// Mutable registry for result handlers keyed by slice name.
pub struct ResultHandlerRegistry {
	handlers: OnceLock<Mutex<Vec<&'static ResultHandler>>>,
}

impl Default for ResultHandlerRegistry {
	fn default() -> Self {
		Self::new()
	}
}

impl ResultHandlerRegistry {
	/// Creates a new empty registry.
	pub const fn new() -> Self {
		Self {
			handlers: OnceLock::new(),
		}
	}

	/// Returns the number of registered handlers.
	pub fn len(&self) -> usize {
		let handlers = self.handlers.get_or_init(|| Mutex::new(Vec::new()));
		handlers.lock().expect("result handler lock poisoned").len()
	}

	/// Returns true if no handlers are registered.
	pub fn is_empty(&self) -> bool {
		self.len() == 0
	}

	/// Registers a handler for this registry.
	pub fn register(&self, handler: &'static ResultHandler) {
		let handlers = self.handlers.get_or_init(|| Mutex::new(Vec::new()));
		let mut handlers = handlers.lock().expect("result handler lock poisoned");
		if handlers
			.iter()
			.any(|&existing| std::ptr::eq(existing, handler))
		{
			return;
		}
		handlers.push(handler);
	}

	/// Returns a snapshot of registered handlers.
	pub fn snapshot(&self) -> Vec<&'static ResultHandler> {
		let handlers = self.handlers.get_or_init(|| Mutex::new(Vec::new()));
		handlers
			.lock()
			.expect("result handler lock poisoned")
			.clone()
	}
}

/// Extension handlers for action results.
///
/// These run after the core per-variant handler registries generated by
/// `#[derive(DispatchResult)]`. Extension handlers should return
/// [`HandleOutcome::NotHandled`](crate::editor_ctx::HandleOutcome::NotHandled)
/// when they don't apply.
pub static RESULT_EXTENSION_HANDLERS: ResultHandlerRegistry = ResultHandlerRegistry::new();

/// Registers a core handler for `ActionResult::Effects`.
pub fn register_result_handler(handler: &'static ResultHandler) {
	RESULT_EFFECTS_HANDLERS.register(handler);
}

/// Registers an extension handler for action results.
pub fn register_result_extension_handler(handler: &'static ResultHandler) {
	RESULT_EXTENSION_HANDLERS.register(handler);
}

/// Screen-relative cursor position.
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum ScreenPosition {
	/// First visible line (vim H).
	Top,
	/// Middle visible line (vim M).
	Middle,
	/// Last visible line (vim L).
	Bottom,
}

/// Result of executing an action.
///
/// All actions return `ActionResult::Effects(...)` containing composable
/// primitive effects. The `apply_effects` function processes these effects
/// to mutate editor state.
///
/// # Example
///
/// ```ignore
/// use xeno_registry::{ActionEffects, ActionResult, AppEffect, Mode};
///
/// // Motion action
/// ActionResult::Effects(ActionEffects::motion(selection))
///
/// // Composed action: motion + mode change
/// ActionResult::Effects(
///     ActionEffects::motion(sel).with(AppEffect::SetMode(Mode::Insert))
/// )
///
/// // No-op
/// ActionResult::Effects(ActionEffects::ok())
/// ```
#[derive(Debug, Clone, DispatchResult)]
pub enum ActionResult {
	/// Apply a set of composable effects.
	///
	/// This is the sole variant - all editor state changes are expressed
	/// as compositions of primitive [`Effect`](crate::Effect) values.
	Effects(ActionEffects),
}
