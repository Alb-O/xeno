# Flake outputs entry point
# This file is referenced by the auto-generated flake.nix
inputs:
let
  inherit (inputs)
    nixpkgs
    flake-parts
    imp
    ;
in
flake-parts.lib.mkFlake { inherit inputs; } {
  imports = [
    imp.flakeModules.default
  ];

  systems = import inputs.systems;

  # Apply rust-overlay to pkgs for all perSystem modules
  perSystem =
    { system, ... }:
    {
      _module.args.pkgs = import nixpkgs {
        inherit system;
        overlays = [ inputs.rust-overlay.overlays.default ];
      };
    };

  # imp configuration
  imp = {
    src = ../outputs;

    # Extra args available in all output files
    args = {
      inherit nixpkgs;
      rootSrc = ../..;
      treefmt-nix = inputs.treefmt-nix;
      imp-fmt-lib = inputs.imp-fmt.lib;
      rust-overlay = inputs.rust-overlay;
    };

    # Disable exports (not used in this project)
    exports.enable = false;

    # Auto-generate flake.nix from __inputs declarations
    flakeFile = {
      enable = true;
      coreInputs = import ./inputs.nix;
      description = "Xeno";
      outputsFile = "./nix/flake";
      header = ''
        # Auto-generated by imp - DO NOT EDIT
        # Regenerate with: nix run .#imp-flake
      '';
    };
  };
}
